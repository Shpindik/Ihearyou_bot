# Backend API - "–Ø —Ç–µ–±—è —Å–ª—ã—à—É"

## üìã –û–±–∑–æ—Ä

FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è Telegram-–±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π –¥–µ—Ç–µ–π —Å –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º —Å–ª—É—Ö–∞.

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã, –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis) –∏ —Ñ–æ–Ω–æ–≤–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Celery.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
- `main.py` ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç CORS –∏ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
- `api.py` ‚Äî –Ω–∞–±–æ—Ä HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (`/api/auth/*`, `/api/users`). –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
- `auth.py` ‚Äî –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–æ–ª—è–º–∏ –∏ JWT-—Ç–æ–∫–µ–Ω–∞–º–∏, –∞ —Ç–∞–∫–∂–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ FastAPI –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
- `database.py` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞ SQLAlchemy –∏ —Ñ–∞–±—Ä–∏–∫–∏ —Å–µ—Å—Å–∏–π. –ß–∏—Ç–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
- `models.py` ‚Äî –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü `admin_users` –∏ `users`.
- `schemas.py` ‚Äî Pydantic-—Å—Ö–µ–º—ã –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ API –∏ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞.
- `__init__.py` ‚Äî –¥–µ–ª–∞–µ—Ç –∫–∞—Ç–∞–ª–æ–≥ –ø–∞–∫–µ—Ç–æ–º Python.

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
1. –ö–ª–∏–µ–Ω—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST `/api/auth/login` —Å –ª–æ–≥–∏–Ω–æ–º –∏ –ø–∞—Ä–æ–ª–µ–º.
2. `auth.authenticate_user` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Postgres, —Å–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª—å.
3. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è JWT-—Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ `Authorization: Bearer`.
4. –î–ª—è –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Ç–æ–∫–µ–Ω —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è –≤ `get_current_active_admin`; –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–∞–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 401/403.
5. –ó–∞–ø—Ä–æ—Å—ã –∫ `/api/users` –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –±–∞–∑–µ —á–µ—Ä–µ–∑ `AsyncSession`, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ `UserResponse` –∏ –¥–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∞–≤–∞—Ç–∞—Ä.
6. –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∞–≤–∞—Ç–∞—Ä–∞ —Ö—ç–Ω–¥–ª–µ—Ä —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª —Å Telegram Bot API –∏ –∫—ç—à–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∏.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `ADMIN_DATABASE_URL` ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Postgres (–µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω–∞, —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏–∑ `POSTGRES_*`).
- `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`, `DB_HOST`, `DB_PORT` ‚Äî –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
- `ADMIN_SECRET_KEY` ‚Äî —Å–µ–∫—Ä–µ—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ JWT (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–º–µ–Ω–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ).
- `ADMIN_TOKEN_EXPIRE` ‚Äî –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60).
- `ADMIN_USERNAME`, `ADMIN_PASSWORD` ‚Äî –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞.
- `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
- `REDIS_URL` ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis (–Ω–∞–ø—Ä–∏–º–µ—Ä, `redis://redis:6379/0`).



## –ü—Ä–∏–º–µ—Ä—ã API-–∑–∞–ø—Ä–æ—Å–æ–≤

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã (–∫—Ä–æ–º–µ –ª–æ–≥–∏–Ω–∞) —Ç—Ä–µ–±—É—é—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <TOKEN>`.

### 1) –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞

```bash
curl -X POST \
  -d 'username=admin&password=admin12345' \
  http://localhost:8001/api/auth/login
```

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:

```json
{
  "access_token": "<JWT>",
  "token_type": "bearer"
}
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ `access_token` –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

### –ü—É–±–ª–∏—á–Ω—ã–µ

- –ü–æ–ª—É—á–∏—Ç—å –º–µ–Ω—é (1 —É—Ä–æ–≤–µ–Ω—å):
```bash
curl "http://localhost:8001/api/v1/menu-items?telegram_user_id=123456789"
```

- –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –ø—É–Ω–∫—Ç–∞:
```bash
curl "http://localhost:8001/api/v1/menu-items/1/content?telegram_user_id=123456789"
```

- –ó–∞–ø–∏—Å–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:
```bash
curl -X POST "http://localhost:8001/api/v1/user-activities" \
  -H "Content-Type: application/json" \
  -d '{"telegram_user_id":123456789, "menu_item_id":1, "activity_type":"navigation"}'
```

- –û—Ü–µ–Ω–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª:
```bash
curl -X POST "http://localhost:8001/api/v1/ratings" \
  -H "Content-Type: application/json" \
  -d '{"telegram_user_id":123456789, "menu_item_id":42, "rating":5}'
```

- –°–æ–∑–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```bash
curl -X POST "http://localhost:8001/api/v1/user-questions" \
  -H "Content-Type: application/json" \
  -d '{"telegram_user_id":123456789, "question_text":"–ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å –∞–ø–ø–∞—Ä–∞—Ç?"}'
```

### –ê–¥–º–∏–Ω

- –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ (JWT —Ç—Ä–µ–±—É–µ—Ç—Å—è):
```bash
curl -H "Authorization: Bearer <JWT>" \
  "http://localhost:8001/api/v1/admin/user-questions?page=1&limit=20&status=pending"
```

- –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å (JWT —Ç—Ä–µ–±—É–µ—Ç—Å—è):
```bash
curl -X PUT -H "Authorization: Bearer <JWT>" \
  -H "Content-Type: application/json" \
  -d '{"answer_text":"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–æ–ø—Ä–æ—Å! ..."}' \
  "http://localhost:8001/api/v1/admin/user-questions/10"
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
backend/
‚îú‚îÄ‚îÄ api/                    # HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (v1/public, v1/admin, v1/bot)
‚îú‚îÄ‚îÄ core/                   # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —É—Ç–∏–ª–∏—Ç—ã (config, db, cache, celery_app)
‚îú‚îÄ‚îÄ crud/                   # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
‚îú‚îÄ‚îÄ models/                 # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îú‚îÄ‚îÄ schemas/                # Pydantic —Å—Ö–µ–º—ã
‚îú‚îÄ‚îÄ services/               # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (menu_item, user_activity, question, notification)
‚îú‚îÄ‚îÄ alembic/               # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îú‚îÄ‚îÄ main.py                # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îî‚îÄ‚îÄ load_flow_data.py      # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
poetry install

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
poetry shell
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª –ø–æ –ø—Ä–∏–º–µ—Ä—É `.env.example`

### 3. –ó–∞–ø—É—Å–∫

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
poetry run uvicorn main:app --reload

# –ò–ª–∏ —á–µ—Ä–µ–∑ Docker
docker-compose up -d
```

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
poetry run alembic revision --autogenerate -m "–æ–ø–∏—Å–∞–Ω–∏–µ"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
poetry run alembic upgrade head
```

### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (flow)

```bash
# –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–µ–Ω—é
docker-compose run --rm bot_api python backend/load_flow_data.py
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

```bash
# Health check
curl http://localhost:8001/health
```

### –†–∞–±–æ—Ç–∞—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Å–≤–æ–¥–∫–∞)

- –ü—É–±–ª–∏—á–Ω—ã–µ: `GET /api/v1/menu-items`, `GET /api/v1/menu-items/{id}/content`, `POST /api/v1/user-activities`, `POST /api/v1/ratings`, `POST /api/v1/user-questions`
- –ê–¥–º–∏–Ω: `GET /api/v1/admin/user-questions`, `PUT /api/v1/admin/user-questions/{id}`

## üìö API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **Swagger UI**: http://localhost:8001/docs
- **ReDoc**: http://localhost:8001/redoc

## ‚öôÔ∏è –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)

- –í–∫–ª—é—á–∞–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `REDIS_URL`.
- –ö–ª—é—á–∏:
  - `menu_items:{telegram_user_id}:{parent_id|root}` ‚Äî —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é (TTL 300 —Å–µ–∫)
  - `menu_content:{telegram_user_id}:{menu_id}` ‚Äî –∫–æ–Ω—Ç–µ–Ω—Ç –ø—É–Ω–∫—Ç–∞ (TTL 300 —Å–µ–∫)
- –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è: –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ `backend/load_flow_data.py` (–æ—á–∏—Å—Ç–∫–∞ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º `menu_items:` –∏ `menu_content:`).

## üì® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Celery)

- –ü—Ä–∏ –æ—Ç–≤–µ—Ç–µ –∞–¥–º–∏–Ω–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å —Å—Ç–∞–≤–∏—Ç—Å—è Celery-–∑–∞–¥–∞—á–∞ `backend.tasks.send_telegram_message`.
- –ë—Ä–æ–∫–µ—Ä –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî Redis (`REDIS_URL`).
- –ó–∞–ø—É—Å–∫ worker: `docker compose up -d celery_worker`.

## üîß –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞

1. –ú–æ–¥–µ–ª—å –≤ `models/`
2. CRUD –≤ `crud/`
3. –°—Ö–µ–º—ã –≤ `schemas/`
4. –≠–Ω–¥–ø–æ–∏–Ω—Ç –≤ `api/v1/`
5. –†–æ—É—Ç–µ—Ä –≤ `api/routers.py`

### –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
poetry run black backend/
poetry run isort backend/
poetry run flake8 backend/
```
